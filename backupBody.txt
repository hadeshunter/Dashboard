create or replace PACKAGE BODY                                                                                         DASHBOARD AS

PROCEDURE tke_lm_go_theo_dvtb
  (
      i_Thang in varchar2, --yyyymm
      i_TTVT in number,
      o_data OUT sys_refcursor   
   ) AS
   v_sql varchar2(32000);
   i_count NUMBER;
BEGIN
    begin
      select count(*) into i_count from kiemsoat.th_go_lm_theo_dvtb
      where nam = to_number(SUBSTR(i_Thang,1,4)) and thang = (SUBSTR(i_Thang,5,2)); 
      exception
        when no_data_found then i_count := 0;
    end;
    if i_count=0 then
    --lay thang hien tai
      v_sql :='
              with tk as 
              (
              select to_number(TO_char(a.ngay_yc,''mm'')) thang, to_number(TO_char(a.ngay_yc,''yyyy'')) nam,
                        hdtb_id,thuebao_id, loaitb_id, dichvuvt_id
                     , ma_tb, ngay_bbbg, ngaycn_bbbg,donvi_id ttvt, a.tovt
                     ,ngay_yc,ten_kieuld,kieuld_id, tthd_id , ten_tb ,0 soluong_lm, 1 soluong_go
                     ,case when loaitb_id in (61,171) then ''MyTV''
                          when loaitb_id=11 then ''MegaVNN''
                          when loaitb_id=58 then ''FiberVNN''
                      else 
                          (select ten_dvvt from CSS_HCM.dichvu_vt where dichvuvt_id=a.dichvuvt_id)
                      end dichvu,
                      (select ten_dv from ADMIN_HCM.donvi where donvi_id = a.donvi_id) as ten_dv
              from BAOCAO_PTTB.mv_pct_go a
              where to_char(a.ngay_yc,''yyyymm'') = '||i_Thang||'
              union all
              --LẮP MỚI
              select to_number(TO_char(NGAYCN_BBBG,''mm'')) thang, to_number(TO_char(NGAYCN_BBBG,''yyyy'')) nam,
              a.hdtb_id, a.thuebao_id, a.loaitb_id, a.dichvuvt_id 
                      , A.ma_tb, A.ngay_bbbg, A.ngaycn_bbbg, A.donvi_id_hd ttvt, A.donvi_id_ttvt tovt 
                      , A.ngay_yc, A.ten_kieuld , A.kieuld_id, A.tthd_id, A.ten_tb,1 soluong_lm, 0 soluong_go
                      , case when loaitb_id in (61,171) then ''MyTV''
                          when loaitb_id=11 then ''MegaVNN''
                          when loaitb_id=58 then ''FiberVNN''
                        else 
                          (select ten_dvvt from CSS_HCM.dichvu_vt where dichvuvt_id=a.dichvuvt_id)
                        end dichvu ,
              (select ten_dv from ADMIN_HCM.donvi where donvi_id = A.donvi_id_hd) as ten_dv
              from baocao_pttb.V_PCT_LAPMOI a 
              where to_char(NGAYCN_BBBG,''yyyymm'')='||i_Thang||'
                    and loaihd_id not in (6)--chuyển đổi loại hình
              )  
              select nam,thang,ttvt,tovt,dichvu,sum(soluong_lm) soluong_lm, sum(soluong_go) soluong_go,ten_dv 
              from tk tk
              group by nam,thang,ttvt,tovt,dichvu,ten_dv
      ';
    else
    --lay thang old
      v_sql :='Select a.*,(select ten_dv from ADMIN_HCM.donvi where donvi_id = a.ttvt) as ten_dv from kiemsoat.th_go_lm_theo_dvtb a
      where nam = to_number(SUBSTR('|| i_Thang ||',1,4)) and thang = to_number(SUBSTR('||i_Thang||',5,2))'
                          ;
    end if; 
     open o_data for v_sql ;
END ;  


/* ------------------------------------------------------------------------
   |  Mô ta: Report - 
   |  Thuc hien: Khanh
   |  Ngày tao: 28/08/2020
*/ ------------------------------------------------------------------------
PROCEDURE i8_sudung_mobile_app_by_khanh
     (
        vtungay varchar2,           --dd/mm/yyyy
        vdenngay varchar2,          --dd/mm/yyyy
        vdonvi_id number, -- truyen 1 la  vttp =2 là đơn vị ngoài trung tâm viễn thong
        returnds out SYS_REFCURSOR
    )
    IS
    vdovi number;
    BEGIN
    -- trường hợp là 1 là lấy toàn bộ các trung tâm viễn thông thì cập nhật đơn vị cha là 0 do grafana ko cho phép 0
    if vdonvi_id =  1 then vdovi := 0  ; else vdovi:=vdonvi_id; end if;-- 
    if vdonvi_id <> 2 then 
       OPEN returnds FOR
       -- Lấy các đơn vị trong viễn thông thành phố
              select  count(distinct nd.nhanvien_id) as login,
                  dv.donvi_id,
                  dv.ten_dv,
                  dv.donvi_cha_id as ttvt_id,
                  (select ten_dv from admin_hcm.donvi where donvi_id = dv.donvi_cha_id) as ttvt,
                  (select count(*) from nhanvien where donvi_id = dv.donvi_id) as tong,
                  round(count(distinct nd.nhanvien_id)/(select count(*) from nhanvien where donvi_id = dv.donvi_id),2) as ty_le
              from ADMIN_hcm.log_action action,ADMIN_hcm.nguoidung nd, ADMIN_hcm.nhanvien nv,donvi dv
              where action_name = 'Login' 
                    and key_parameter='WebAPi.PostDangNhap'
                    and action.user_name=nd.ma_nd
                    and nd.nhanvien_id = nv.nhanvien_id
                    and nv.donvi_id = dv.donvi_id
                    and dv.donvi_cha_id in (41,42,43,44,45,56,57,59,60)
                    and dv.donvi_id  in( Select donvi_id
                                        From ADMIN_HCM.donvi start
                                        with donvi_id = ''||vdovi||''
                                        connect by prior donvi_id = donvi_cha_id )
                    and nd.nhanvien_id in(
                      select nhanvien_id from ADMIN_hcm.nhanvien_lnv
                      where loainv_id in(5,6,11,21,51)
                        and nhanvien_id in(
                              select nhanvien_id from ADMIN_hcm.nguoidung
                              where trangthai=1
                            )) 
                    and action.datetime BETWEEN to_date(''||vtungay||'','dd/mm/yyyy') and to_date(''||vdenngay||'','dd/mm/yyyy')
            group by (dv.donvi_id ,dv.donvi_cha_id,dv.ten_dv) order by donvi_cha_id
            ;
        else-- lấy đơn vị ngoài viễn thông thành phố
         OPEN returnds FOR 
             select  count(distinct nd.nhanvien_id) as login,
                  dv.donvi_id,
                  dv.ten_dv,
                  dv.donvi_cha_id as ttvt_id,
                  (select ten_dv from admin_hcm.donvi where donvi_id = dv.donvi_cha_id) as ttvt,
                  (select count(*) from nhanvien where donvi_id = dv.donvi_id) as total,
                  round(count(distinct nd.nhanvien_id)/(select count(*) from nhanvien where donvi_id = dv.donvi_id),2) as ty_le
              from ADMIN_hcm.log_action action,ADMIN_hcm.nguoidung nd, ADMIN_hcm.nhanvien nv,donvi dv
              where action_name = 'Login' 
                    and key_parameter='WebAPi.PostDangNhap'
                    and action.user_name=nd.ma_nd
                    and nd.nhanvien_id = nv.nhanvien_id
                    and nv.donvi_id = dv.donvi_id
                    and dv.donvi_cha_id not in (41,42,43,44,45,56,57,59,60)
                    and nd.nhanvien_id in(
                      select nhanvien_id from ADMIN_hcm.nhanvien_lnv
                      where loainv_id in(5,6,11,21,51)
                        and nhanvien_id in(
                              select nhanvien_id from ADMIN_hcm.nguoidung
                              where trangthai=1
                            )) 
                    and action.datetime BETWEEN to_date(''||vtungay||'','dd/mm/yyyy') and to_date(''||vdenngay||'','dd/mm/yyyy')
            group by (dv.donvi_id ,dv.donvi_cha_id,dv.ten_dv) order by donvi_cha_id
         ;
        end if;
 END i8_sudung_mobile_app_by_khanh;

/* ------------------------------------------------------------------------
   |  Mô ta: Report - 
   |  Thuc hien: Khanh
   |  Ngày tao: 28/08/2020
*/ ------------------------------------------------------------------------
PROCEDURE tke_daonhthupsc_theotucap
     (
        vthang number,
        returnds out SYS_REFCURSOR
    )
    IS
     v_Query varchar2(4000);
     vthang1 varchar2(4000);
     vthang2 varchar2(4000);
    BEGIN
    vthang1:= to_char(ADD_MONTHS( TO_DATE(''||vthang||'','yyyyMM'),-1),'yyyyMM');
    vthang2:= to_char(ADD_MONTHS( TO_DATE(''||vthang||'','yyyyMM'),-2),'yyyyMM');
      v_Query:= 'select * from (
            select * from (
                select '||vthang||' as thang,tien,loaidv_id,
                decode(TTVT,2,41,1,42,3,43,5,44,4,45,6,56,7,57,9,59,8,60) ttvt,
                (select  ten_dv from admin_hcm.donvi where donvi_id=decode(TTVT,2,41,1,42,3,43,5,44,4,45,6,56,7,57,9,59,8,60)) ten
                from KIEMSOAT.SOLIEUTONGHOP_'||vthang||'
            union all
                select '||vthang||' as thang,dtpsc tien,-10 loaidv_id, ttvt,
                (select  ten_dv from admin_hcm.donvi where donvi_id=a.ttvt) ten
                --select * 
                from KIEMSOAT.ct_ktr_'||vthang||' a --where ttvt=5
                where loaitb_id<>999
                )PIVOT (sum(tien) FOR loaidv_id IN (1 dienthoai,2 gp ,5 mega,6 fiber,10 TSL,11 mytv,-10 ktr))
            union
                select * from (
                select '||vthang1||' as thang,tien,loaidv_id,
                decode(TTVT,2,41,1,42,3,43,5,44,4,45,6,56,7,57,9,59,8,60) ttvt,
                (select  ten_dv from admin_hcm.donvi where donvi_id=decode(TTVT,2,41,1,42,3,43,5,44,4,45,6,56,7,57,9,59,8,60)) ten
                from KIEMSOAT.SOLIEUTONGHOP_'||vthang1||' a
            union all
                select '||vthang1||' as thang,dtpsc tien,-10 loaidv_id, ttvt,
                (select  ten_dv from admin_hcm.donvi where donvi_id=a.ttvt) ten
                --select * 
                from KIEMSOAT.ct_ktr_'||vthang1||'  a 
                where loaitb_id<>999
                )PIVOT (sum(tien) FOR loaidv_id IN (1 dienthoai,2 gp ,5 mega,6 fiber,10 TSL,11 mytv,-10 ktr))
             union
                select * from (
                select '||vthang2||' as thang,tien,loaidv_id,
                decode(TTVT,2,41,1,42,3,43,5,44,4,45,6,56,7,57,9,59,8,60) ttvt,
                (select  ten_dv from admin_hcm.donvi where donvi_id=decode(TTVT,2,41,1,42,3,43,5,44,4,45,6,56,7,57,9,59,8,60)) ten
                from KIEMSOAT.SOLIEUTONGHOP_'||vthang2||' a
            union all
                select '||vthang2||' as thang,dtpsc tien,-10 loaidv_id, ttvt,
                (select  ten_dv from admin_hcm.donvi where donvi_id=a.ttvt) ten
                --select * 
                from KIEMSOAT.ct_ktr_'||vthang2||'  a 
                where loaitb_id<>999
                )PIVOT (sum(tien) FOR loaidv_id IN (1 dienthoai,2 gp ,5 mega,6 fiber,10 TSL,11 mytv,-10 ktr))
                
                )
            order by ttvt,thang';
            OPEN returnds FOR v_Query;
END tke_daonhthupsc_theotucap;

/* ------------------------------------------------------------------------
   |  Mô ta: Report - 
   |  Thuc hien: Khanh
   |  Ngày tao: 28/08/2020
*/ ------------------------------------------------------------------------
PROCEDURE tke_lapmoigo_thuebao
     (
        vthang varchar2,
        returnds out SYS_REFCURSOR
    )
    IS
     v_Query varchar2(4000);
     t number;
     vthang1 varchar2(4000);
     vthang2 varchar2(4000);
    BEGIN
    vthang1:= to_char(ADD_MONTHS( TO_DATE(''||vthang||'','yyyyMM'),-1),'yyyyMM');
    vthang2:= to_char(ADD_MONTHS( TO_DATE(''||vthang||'','yyyyMM'),-2),'yyyyMM');
    v_Query := '
        select nam,thang,ttvt,ten_ttvt,dichvu,sum(sl_lm) LapMoi,sum(sl_go) Go,sum(sl_lm)-sum(sl_go) as tile_tanggiam
        
        from kiemsoat.PCT_GO_LM_TH
        where to_char(to_char(nam) || (case when thang >10 then to_char(thang)else(''0'' || thang) end)) in ('||vthang||','||vthang1||')
        group by nam,thang,ten_ttvt,dichvu,ttvt
        order by ttvt
    ';
     OPEN returnds FOR v_Query;
END tke_lapmoigo_thuebao;

/* ------------------------------------------------------------------------
   |  Mô ta: Report - Chgi tiet Mytv fiber
   |  Thuc hien: Khanh
   |  Ngày tao: 28/08/2020
*/ ------------------------------------------------------------------------
PROCEDURE detail_fiber_mytv
    (
          i_tuNgay in varchar2, --dd-mm-yyyy
          i_denNgay in varchar2, --dd-mm-yyyy
          o_data OUT sys_refcursor   
    )
    IS
     v_Query varchar2(4000);
    BEGIN
    v_Query := '
        SELECT tb.thuebao_id, kh.hdkh_id,kh.ma_gd, tb.hdtb_id,
                        kh.ctv_id,
                        tb.ma_tb,tb.ten_tb,tb.diachi_ld, tb.ngay_ins AS ngaycn_bbbg, tb.ngay_ht AS ngay_bbbg,tb.dichvuvt_id, tb.donvi_id,
                        CASE WHEN tb.loaitb_id=58 THEN 1 ELSE 0 END fibervnn,
                        CASE WHEN tb.loaitb_id IN (61,171) THEN 1 ELSE 0 END mytv,
                        CASE WHEN nvl(DV.donvi_cha_id,0)=0 THEN DV.donvi_id 
                             WHEN (nvl(DV.donvi_cha_id,0)<>0 AND DV.donvi_cha_id NOT IN (14,2942,2943,2944,2945,2946,2947,10082,10115,11352,41,42,43,44,45,56,57,59,60))
                                  THEN (SELECT donvi_cha_id FROM admin_hcm.donvi WHERE donvi_id=DV.donvi_cha_id)
                             ELSE DV.donvi_cha_id END donvi_tt
                      FROM css_hcm.hd_khachhang kh, css_hcm.hd_thuebao tb, admin_hcm.nhanvien nv,
                        admin_hcm.donvi DV
                      WHERE kh.hdkh_id = tb.hdkh_id AND tb.loaitb_id IN (58,61,171) AND  kh.loaihd_id=1 AND tb.tthd_id=6
                        AND tb.ngay_ins BETWEEN TO_DATE('''||i_tuNgay||''',''dd-MM-yyyy'') AND TO_DATE('''||i_denNgay||''',''dd-MM-yyyy'') 
                        AND kh.ctv_id=nv.nhanvien_id (+)
                        AND nv.donvi_id = DV.donvi_id(+)
    ';
     OPEN o_data FOR v_Query;
END detail_fiber_mytv;


/* ------------------------------------------------------------------------
   |  Mô ta: Report - Chgi tiet Mytv fiber
   |  Thuc hien: Khanh
   |  Ngày tao: 28/08/2020
*/ ------------------------------------------------------------------------
PROCEDURE detail_sl_thuctang
    (
          o_data OUT sys_refcursor   
    )
    IS
     v_Query varchar2(4000);
    BEGIN
    v_Query := '
         select tb.thuebao_id, kh.hdkh_id,kh.ma_gd, tb.hdtb_id,kh.ctv_id,
                    tb.ma_tb,tb.ten_tb,tb.diachi_ld, tb.ngay_ins as ngaycn_bbbg, 
                    tb.ngay_ht as ngay_bbbg,tb.dichvuvt_id, tb.donvi_id,1 lapmoi,
                    case 
                        when nvl(dv.donvi_cha_id,0)=0 then dv.donvi_id 
                        when (nvl(dv.donvi_cha_id,0)<>0 and dv.donvi_cha_id not in (14,2942,2943,2944,2945,2946,2947,10082,10115,11352,41,42,43,44,45,56,57,59,60))
                        then (select donvi_cha_id from admin_hcm.donvi where donvi_id=dv.donvi_cha_id)
                        else dv.donvi_cha_id 
                    end donvi_tt,
                    case when loaitb_id = 58 then 1 else 0 end fiber,
                    case when loaitb_id in (61,171) then 1 else 0 end mytv
                    from css_hcm.hd_khachhang kh, css_hcm.hd_thuebao tb, admin_hcm.nhanvien nv, admin_hcm.donvi dv
                    where kh.hdkh_id = tb.hdkh_id and tb.loaitb_id in (58,61,171) 
                          and ( kh.loaihd_id=1 or tb.kieuld_id in (  182,300,284,300,284,293,294,296,295,297,298,299,303,301))
                          and tb.tthd_id=6
                          and to_char(tb.ngay_ins,''yyyyMM'') = 202009
                          and tb.ngay_ins < sysdate 
                          and kh.ctv_id=nv.nhanvien_id (+)
                          and nv.donvi_id = dv.donvi_id(+)
    ';
     OPEN o_data FOR v_Query;
END detail_sl_thuctang;

/* ------------------------------------------------------------------------
   |  Mô ta: Report - Chi tiet lap moi
   |  Thuc hien: Khanh
   |  Ngày tao: 28/08/2020
*/ ------------------------------------------------------------------------
PROCEDURE detail_lapmoi
    (
        vtungay varchar2,
        vdenngay varchar2,
        vloaitb_id number,
        o_data OUT sys_refcursor   
    )
    IS
     v_Query varchar2(4000);
     v_filter varchar2(4000);
    BEGIN
    if vloaitb_id = 61 then
         v_filter:= 'and tb.loaitb_id in (61,171)';
    elsif  vloaitb_id <> 0 then
        v_filter:= 'and tb.loaitb_id = '||vloaitb_id||'';
        end if;
    v_Query := '
--     select * from khanhnv.detail_lapmoi where ngaycn_bbbg BETWEEN TO_DATE('''||vtungay||''',''dd-MM-yyyy'') AND TO_DATE('''||vdenngay||''',''dd-MM-yyyy'') '||v_filter||'
--     order by ngaycn_bbbg

        select 
            tb.thuebao_id,
            kh.hdkh_id,
            kh.ma_gd,
            tb.hdtb_id,
            kh.ctv_id,
            tb.ma_tb,
            tb.ten_tb,
            tb.diachi_ld,
            tb.ngay_ins as ngaycn_bbbg,
            tb.ngay_ht as ngay_bbbg,
            tb.dichvuvt_id,
            tb.donvi_id,
            tb.loaitb_id,
            (select dv.donvi_cha_id from Admin_hcm.donvi 
             where donvi_id = case when  dv.donvi_cha_id in (14,2942,2943,2944,2945,2946,2947,10082,10115,11352,41,42,43,44,45,56,57,59,60) then dv.donvi_cha_id
                                   else (select donvi_cha_id from Admin_HCM.donvi where donvi_id = dv.donvi_cha_id) end
            ) as dvicha_id_tt,
            
            dv.donvi_id as dvi_id_tt,
            (select donvi_id from donvi where donvi_id =  (select donvi_cha_id from donvi where donvi_id = hdtbdv.donvi_id)) as dvicha_id_tc,
            hdtbdv.donvi_id as dvi_id_tc,
            pbh.tenphong,
            pbh.pbh_id,
            pbh.tentat,
            kh.loaihd_id,
            tb.kieuld_id,
            nv.ten_nv as nv_tiepthi,
            nv.nhanvien_id as nvtt_id
            ,
            case when tb.loaitb_id=58 then ''Fiber''
                  when tb.loaitb_id=61 then ''MyTV''
             end  Loai_chi_phi
        
    from css_hcm.hd_khachhang kh, css_hcm.hd_thuebao tb, admin_hcm.nhanvien nv,
         admin_hcm.donvi dv, CSS_HCM.hdtb_dv hdtbdv,TTKD_BCT.db_thuebao_ttkd tbttkd,ttkd_bct.phongbanhang pbh
    where kh.hdkh_id = tb.hdkh_id
         and tb.tthd_id = 6
        and TB.LOAITB_ID IN (58,61,171) 
        and kh.ctv_id=nv.nhanvien_id (+)
        and nv.donvi_id = dv.donvi_id(+)
        AND ( KH.LOAIHD_ID=1)
        and tb.hdtb_id = hdtbdv.hdtb_id(+)
        and hdtbdv.loaidv_id =5
        and tbttkd.thuebao_id(+) = tb.thuebao_id
        and pbh.pbh_id(+) = tbttkd.pbh_ql_id
        --and hdtbdv.kieudv_id =2 --1/2 nam sau hoi
        AND tb.ngay_ins >= TO_DATE('''||vtungay||''',''dd-MM-yyyy'') 
        AND tb.ngay_ins < TO_DATE('''||vdenngay||''',''dd-MM-yyyy'') +1
        '||v_filter||'
    order by tb.ngay_ins
    ';
     OPEN o_data FOR v_Query;
END detail_lapmoi;

/* ------------------------------------------------------------------------
   |  Mô ta: Report - Chi tiet go
   |  Thuc hien: Khanh
   |  Ngày tao: 28/08/2020
*/ ------------------------------------------------------------------------
PROCEDURE detail_go
    (
        vtungay varchar2,
        vdenngay varchar2,
        vloaitb_id number,
        o_data OUT sys_refcursor   
    )
    IS
     v_Query varchar2(4000);
     v_filter varchar2(4000);
    BEGIN
     if vloaitb_id = 61 then
         v_filter:= 'and loaitb_id in (61,171)';
     elsif  vloaitb_id <> 0 then
        v_filter:= 'and loaitb_id = '||vloaitb_id||'';
        end if;
    v_Query :='
       select pct.*,(select ten_dv from ADMIN_HCM.donvi where donvi_id = pct.donvi_id) as ten_dv
        from BAOCAO_PTTB.mv_pct_go pct
        where  NGAYCN_BBBG >= TO_DATE('''||vtungay||''',''dd/mm/yyyy'') and  NGAYCN_BBBG < TO_DATE('''||vdenngay||''',''dd/mm/yyyy'')+1 '||v_filter||'
        order by pct.donvi_id,NGAYCN_BBBG
    ';
     OPEN o_data FOR v_Query;
END detail_go;


/* ------------------------------------------------------------------------
   |  Mô ta: Report - Chi tiet go
   |  Thuc hien: Khanh
   |  Ngày tao: 28/08/2020
*/ ------------------------------------------------------------------------
PROCEDURE getTTVT_DoiVT
    (
        o_data OUT sys_refcursor   
    )
    IS
     v_Query varchar2(4000);
    BEGIN
    v_Query :='
       select donvi_id, ten_dv, donvi_cha_id ,(select ten_dv from admin_hcm.donvi where donvi_id = dv.donvi_cha_id ) as ten_tt
       from admin_hcm.donvi dv where donvi_cha_id in (41,42,43,44,45,56,57,59,60)
    ';
     OPEN o_data FOR v_Query;
END getTTVT_DoiVT;


/* ------------------------------------------------------------------------
   |  Mô ta: Report - Chi tiet go
   |  Thuc hien: Khanh
   |  Ngày tao: 28/08/2020
*/ ------------------------------------------------------------------------
PROCEDURE getTTVT
    (
        o_data OUT sys_refcursor   
    )
    IS
     v_Query varchar2(4000);
    BEGIN
    v_Query :='
       select donvi_id, ten_dv
       from admin_hcm.donvi dv where donvi_id in (41,42,43,44,45,56,57,59,60,14,2942,2943,2944,2945,2946,2947,10082,10115,11352)
    ';
     OPEN o_data FOR v_Query;
END getTTVT;


PROCEDURE i8NghiemThuByKhanh
    (
        vtungay varchar2,
        vdenngay varchar2,
        o_data OUT sys_refcursor   
    )
    IS
     v_Query varchar2(4000);
     vdenngaymin varchar2(100);
     vsysdatemin varchar2(100);
    BEGIN
    vdenngaymin := '01/'|| substr(''||vdenngay||'',4,2) ||'/'|| substr(''||vdenngay||'',7,4);
    vsysdatemin := '01/'|| substr(to_char(sysdate,'dd/MM/yyyy'),4,2) ||'/'|| substr(to_char(sysdate,'dd/MM/yyyy'),7,4);
    if(to_date(vdenngay,'dd/MM/yyyy') < to_date(vsysdatemin,'dd/MM/yyyy')) then
      v_Query :=' select 
       donvi_id,doi_vt,donvi_cha_id, TTVT,to_date(ngay_ht,''dd/MM/yyyy'') as ngay_ht
              ,pct_ccdv_va_scdv_hoan_tat,pct_hoan_tat_qua_mobile_app 
      from  khanhnv.I8mobileapp hd where to_date(hd.ngay_ht,''dd/MM/yyyy'') >= to_date('''||vtungay||''',''dd/MM/yyyy'') 
       and to_date(hd.ngay_ht,''dd/MM/yyyy'') <= to_date('''||vdenngay||''',''dd/MM/yyyy'')';
    elsif (to_date(vtungay,'dd/MM/yyyy') <= to_date(vsysdatemin,'dd/MM/yyyy')) then
     v_Query :='
      select * from (
  
             select donvi_id,ten_dv doi_vt,donvi_cha_id, ten_dvql TTVT, to_date(to_char(ngay_ht,''dd/MM/yyyy''),''dd/MM/yyyy'') ngay_ht
              ,(sl) pct_ccdv_va_scdv_hoan_tat, (nt_app) pct_hoan_tat_qua_mobile_app--,round((sum(nt_app) * 100 / sum(sl)),2) ty_le 
              from
              (select --c.hdtb_id,d.huonggiao,nv.ma_nv || ''-'' || nv.ten_nv nhanvien_th,c.donvi_nhan_id,dvn.donvi_cha_id,
              dvn.donvi_id,dvn.ten_dv,dvn.donvi_cha_id,dvn.ten_dvql,hd.ngay_ins ngay_ht, 1 sl--, (case when log.action_name is not null then 1 else 0 end) nt_app
              , case when instr((select listagg (may_cn,'','') within group (order by phieu_id) from css_hcm.giaophieu 
                  where hdtb_id = hd.hdtb_id),''SMP'') > 0 then 1 else 0 end nt_app
              from css_hcm.giaophieu c,css_hcm.huonggiao d ,css_hcm.hd_thuebao hd
                  , css_hcm.hd_khachhang kh,admin_hcm.donvi dvn,admin_hcm.nhanvien nv            
              where hd.hdkh_id=kh.hdkh_id
                      and kh.loaihd_id in(1,3,6,30) and hd.loaitb_id not in (14,15,16,17) and hd.dichvuvt_id not in (7,8,9)
                      and hd.hdtb_id = c.hdtb_id and hd.tthd_id=6
                      and c.huonggiao_id = d.huonggiao_id and d.tthd_id in (3,4)
                      and c.phieu_id in(select max(phieu_id) from css_hcm.giaophieu gg, css_hcm.huonggiao hh
                                                              where hdtb_id=c.hdtb_id and gg.huonggiao_id=hh.huonggiao_id and hh.tthd_id in (3,4))
                  and dvn.donvi_id=c.donvi_nhan_id 
                  and nv.nhanvien_id=c.nhanvien_th_id(+)
                  and dvn.donvi_id  not  in (211,262,189,247,488,506,372,520,210,229) 
                  and dvn.donvi_id  <> 484 
                  and dvn.donvi_cha_id in (41,42,43,44,45,56,57,59,60)
                  and trunc(hd.ngay_ins) BETWEEN to_date('''||vtungay||''',''dd/MM/yyyy'') and to_date('''||vdenngay||''',''dd/MM/yyyy'')
                  
              union all
              
              select dvn.donvi_id,dvn.ten_dv,dvn.donvi_cha_id,dvn.ten_dvql,a.ngay_ht, 1 sl
              , case when instr((select listagg (may_cn,'','') within group (order by phieu_id) from baohong_hcm.giaophieu 
                      where baohong_id = a.baohong_id),''VNPT-'') > 0 then 1 else 0 end nt_app
              from baohong_hcm.baohong a,css_hcm.db_thuebao b,baohong_hcm.giaophieu gp, admin_hcm.donvi dvn
              where 
                  a.ttbh_id=6 and a.dichvuvt_id in(1,4,7,8,9,11)
                  and a.thuebao_id=b.thuebao_id and a.baohong_id=gp.baohong_id
                  and a.khoaphieu=0 and nvl(gp.nd_giao,''1'') not like ''[LAC HUONG]%''
                  and gp.phieu_id=(select max(phieu_id) from baohong_HCM.giaophieu aa, css_HCM.huonggiao bb
                                                where aa.huonggiao_id = bb.huonggiao_id and bb.ttbh_id in (1,3,8) and aa.baohong_id = a.baohong_id and aa.ttph_id<>3)
                  and gp.donvi_nhan_id=dvn.donvi_id and a.donvi_ins_id not in (552,556) and dvn.donvi_id  not  in (211,262,189,247,488,506,372,520,210,229) and dvn.donvi_id  <> 484
                  and dvn.donvi_cha_id in (41,42,43,44,45,56,57,59,60)
                  and trunc(a.ngay_ht) BETWEEN to_date('''||vtungay||''',''dd/MM/yyyy'') and to_date('''||vdenngay||''',''dd/MM/yyyy'')
                  ) order by ngay_ht
                  )
     ';
     else
    v_Query :='
       select 
       donvi_id,doi_vt,donvi_cha_id, TTVT,to_date(ngay_ht,''dd/MM/yyyy'') as ngay_ht
              ,pct_ccdv_va_scdv_hoan_tat,pct_hoan_tat_qua_mobile_app 
       from  khanhnv.I8mobileapp hd where to_date(hd.ngay_ht,''dd/MM/YYYY'') >= to_date('''||vtungay||''',''dd/mm/yyyy'') 
       and to_date(hd.ngay_ht,''dd/MM/YYYY'') < to_date('''||vdenngaymin||''',''dd/mm/yyyy'')
      union all
      select * from (
      select donvi_id,ten_dv doi_vt,donvi_cha_id, ten_dvql TTVT, to_date(to_char(ngay_ht,''dd/MM/yyyy''),''dd/MM/yyyy'') ngay_ht
              ,(sl) pct_ccdv_va_scdv_hoan_tat, (nt_app) pct_hoan_tat_qua_mobile_app--,round((sum(nt_app) * 100 / sum(sl)),2) ty_le 
              from
              (select --c.hdtb_id,d.huonggiao,nv.ma_nv || ''-'' || nv.ten_nv nhanvien_th,c.donvi_nhan_id,dvn.donvi_cha_id,
              dvn.donvi_id,dvn.ten_dv,dvn.donvi_cha_id,dvn.ten_dvql,hd.ngay_ins ngay_ht, 1 sl--, (case when log.action_name is not null then 1 else 0 end) nt_app
              , case when instr((select listagg (may_cn,'','') within group (order by phieu_id) from css_hcm.giaophieu 
                  where hdtb_id = hd.hdtb_id),''SMP'') > 0 then 1 else 0 end nt_app
              from css_hcm.giaophieu c,css_hcm.huonggiao d ,css_hcm.hd_thuebao hd
                  , css_hcm.hd_khachhang kh,admin_hcm.donvi dvn,admin_hcm.nhanvien nv            
              where hd.hdkh_id=kh.hdkh_id
                      and kh.loaihd_id in(1,3,6,30) and hd.loaitb_id not in (14,15,16,17) and hd.dichvuvt_id not in (7,8,9)
                      and hd.hdtb_id = c.hdtb_id and hd.tthd_id=6
                      and c.huonggiao_id = d.huonggiao_id and d.tthd_id in (3,4)
                      and c.phieu_id in(select max(phieu_id) from css_hcm.giaophieu gg, css_hcm.huonggiao hh
                                                              where hdtb_id=c.hdtb_id and gg.huonggiao_id=hh.huonggiao_id and hh.tthd_id in (3,4))
                  and dvn.donvi_id=c.donvi_nhan_id 
                  and nv.nhanvien_id=c.nhanvien_th_id(+)
                  and dvn.donvi_id  not  in (211,262,189,247,488,506,372,520,210,229) 
                  and dvn.donvi_id  <> 484 
                  and dvn.donvi_cha_id in (41,42,43,44,45,56,57,59,60)
                  and trunc(hd.ngay_ins) BETWEEN to_date('''||vdenngaymin||''',''dd/mm/yyyy'') and to_date('''||vdenngay||''',''dd/mm/yyyy'')
                  
              union all
              
              select dvn.donvi_id,dvn.ten_dv,dvn.donvi_cha_id,dvn.ten_dvql,a.ngay_ht, 1 sl
              , case when instr((select listagg (may_cn,'','') within group (order by phieu_id) from baohong_hcm.giaophieu 
                      where baohong_id = a.baohong_id),''VNPT-'') > 0 then 1 else 0 end nt_app
              from baohong_hcm.baohong a,css_hcm.db_thuebao b,baohong_hcm.giaophieu gp, admin_hcm.donvi dvn
              where 
                  a.ttbh_id=6 and a.dichvuvt_id in(1,4,7,8,9,11)
                  and a.thuebao_id=b.thuebao_id and a.baohong_id=gp.baohong_id
                  and a.khoaphieu=0 and nvl(gp.nd_giao,''1'') not like ''[LAC HUONG]%''
                  and gp.phieu_id=(select max(phieu_id) from baohong_HCM.giaophieu aa, css_HCM.huonggiao bb
                                                where aa.huonggiao_id = bb.huonggiao_id and bb.ttbh_id in (1,3,8) and aa.baohong_id = a.baohong_id and aa.ttph_id<>3)
                  and gp.donvi_nhan_id=dvn.donvi_id and a.donvi_ins_id not in (552,556) and dvn.donvi_id  not  in (211,262,189,247,488,506,372,520,210,229) and dvn.donvi_id  <> 484
                  and dvn.donvi_cha_id in (41,42,43,44,45,56,57,59,60)
                  and trunc(a.ngay_ht) BETWEEN to_date('''||vdenngaymin||''',''dd/mm/yyyy'') and to_date('''||vdenngay||''',''dd/mm/yyyy'')
                  ) order by ngay_ht
                  )
    ';
    end if;
     OPEN o_data FOR v_Query;
END i8NghiemThuByKhanh;
/* ------------------------------------------------------------------------
   |  Mô ta: Report - combohome
   |  Thuc hien: Khanh
   |  Ngày tao: 01/11/2020
*/ ------------------------------------------------------------------------
PROCEDURE combohome
    (
        v_thang varchar2,--YYYYMM
        o_data OUT sys_refcursor    
    )
    IS
     v_Query varchar2(8000);
    BEGIN
    v_Query :='
        select lm.ten_dv,lm.thuebao_hienhuu_fiber,lm.thuebao_lapmoi_fiber,lm.thuebao_hienhuu_mytv,lm.thuebao_lapmoi_mytv,
        lm.tongso_PTM_HC,nvl(huy.huykhachquan,0) huykhachquan,nvl(huy.huychuquan,0)huychuquan ,nvl(huy.tonghuy,0) tonghuy,
         lm.thuctang - nvl(huy.huykhachquan,0) as thuctang
        from
        (
        select ten_dv, sum(thuebao_hienhuu_fiber) as thuebao_hienhuu_fiber,sum(thuebao_lapmoi_fiber) as thuebao_lapmoi_fiber,
        sum(thuebao_hienhuu_mytv) as thuebao_hienhuu_mytv,sum(thuebao_lapmoi_mytv) as thuebao_lapmoi_mytv,
        sum(thuebao_hienhuu_fiber+ thuebao_lapmoi_fiber) as tongso_PTM_HC ,
        sum(thuctang) as thuctang
        from (
            select dv,
            decode(trang_thai_fiber,''Hien huu'' ,0,1) thuebao_hienhuu_fiber
            ,decode(trang_thai_fiber,''Moi'' ,0,1) thuebao_lapmoi_fiber
            ,decode(trangthai_mytv,''Hien huu'' ,0,1) thuebao_hienhuu_mytv
            ,decode(trangthai_mytv,''Moi'' ,0,1) thuebao_lapmoi_mytv
            ,decode(trangthai_goi,''Dang hoat dong'' ,0,1) thuctang
            ,nvl((select ten_dv from donvi where donvi_id = (select donvi_cha_id from donvi where donvi_id = dv)),''Khac'') as ten_dv
            from(
                select nv.donvi_id as dv, trang_thai_fiber,trangthai_goi,trangthai_mytv
                from ppm_tuyetnt.combohome  cb ,ADMIN_HCM.nhanvien_mnv_hrm nvhrm,Admin_hcm.nhanvien nv
                where   cb.manguoi_gt = nvhrm.manv_hcm 
                    and nvhrm.mnv_hrms = nv.ma_nv 
                    and cb.trangthai_hd = ''Dang hoat dong''
                    and cb.dayupdate = (select max(dayupdate) from ppm_tuyetnt.combohome where to_char(to_date(thoigian_dk,''dd/MM/yyyy hh24:mi:ss''),''YYYYMM'') = '''||v_thang||''')
                    and to_char(to_date(cb.thoigian_dk,''dd/MM/yyyy hh24:mi:ss''),''YYYYMM'') = '''||v_thang||'''
                union  all
                select nv.donvi_id as dv, trang_thai_fiber,trangthai_goi,trangthai_mytv
                from 
                    ppm_tuyetnt.combohome cb, 
                    Admin_hcm.nhanvien nv
                where 
                    cb.manguoi_gt = nv.ma_nv(+)
                    and cb.trangthai_hd = ''Dang hoat dong''
                    and cb.dayupdate = (select max(dayupdate) from ppm_tuyetnt.combohome where to_char(to_date(thoigian_dk,''dd/MM/yyyy hh24:mi:ss''),''YYYYMM'') = '''||v_thang||''')
                    and to_char(to_date(cb.thoigian_dk,''dd/MM/yyyy hh24:mi:ss''),''YYYYMM'') = '''||v_thang||'''
                    and cb.manguoi_gt not in (select manguoi_gt
                                                from 
                                                    ppm_tuyetnt.combohome cb1, 
                                                    ADMIN_HCM.nhanvien_mnv_hrm nvhrm1,
                                                    Admin_hcm.nhanvien nv1
                                                where 
                                                       cb1.manguoi_gt = nvhrm1.manv_hcm
                                                    and nvhrm1.mnv_hrms = nv1.ma_nv
                                                    and cb1.trangthai_hd = ''Dang hoat dong''
                                                    and cb1.dayupdate = (select max(dayupdate) from ppm_tuyetnt.combohome where to_char(to_date(thoigian_dk,''dd/MM/yyyy hh24:mi:ss''),''YYYYMM'') = '''||v_thang||''')
                                                    and to_char(to_date(cb1.thoigian_dk,''dd/MM/yyyy hh24:mi:ss''),''YYYYMM'') = '''||v_thang||'''
                                                    ) 
            
            )
            ) group by ten_dv order by ten_dv
        ) lm
    FULL OUTER JOIN --HUY COMBOHOME
        (select ten_dv,sum(huykhachquan) huykhachquan, sum(huychuquan) huychuquan, sum (huychuquan+ huykhachquan) tonghuy
        from(
        select
            dv,
            decode(thoigian_dki,thoigianhuy ,0,1) huykhachquan,
            decode(thoigian_dki,thoigianhuy ,1,0) huychuquan,
            nvl((select ten_dv from donvi where donvi_id = (select donvi_cha_id from donvi where donvi_id = dv)),''Khac'') as ten_dv
             from (
                   select  nv.donvi_id as dv,substr(cb.thoigian_dki,4,7) as thoigian_dki,substr(cb.thoigianhuy,4,7) as thoigianhuy
                from 
                    ppm_tuyetnt.huycombohome cb, 
                    ADMIN_HCM.nhanvien_mnv_hrm nvhrm,
                    Admin_hcm.nhanvien nv
                where 
                       cb.manguoi_gt = nvhrm.manv_hcm
                    and nvhrm.mnv_hrms = nv.ma_nv
                    and to_char(to_date(cb.thoigian_dki,''dd/MM/yyyy hh24:mi:ss''),''YYYYMM'') = '''||v_thang||'''
                    and cb.dayupdate = (select max(dayupdate) from ppm_tuyetnt.huycombohome where to_char(to_date(thoigian_dki,''dd/MM/yyyy hh24:mi:ss''),''YYYYMM'') = '''||v_thang||''')
               
                union  all
                
                select nv.donvi_id as dv,substr(cb.thoigian_dki,4,7) as thoigian_dki,substr(cb.thoigianhuy,4,7) as thoigianhuy
                from 
                    ppm_tuyetnt.huycombohome cb, 
                    Admin_hcm.nhanvien nv
                where
                    cb.manguoi_gt = nv.ma_nv(+)
                    and to_char(to_date(cb.thoigian_dki,''dd/MM/yyyy hh24:mi:ss''),''YYYYMM'') = '''||v_thang||'''
                    and cb.dayupdate = (select max(dayupdate) from ppm_tuyetnt.huycombohome where to_char(to_date(thoigian_dki,''dd/MM/yyyy hh24:mi:ss''),''YYYYMM'') = '''||v_thang||''')
                    and cb.manguoi_gt not in (select manguoi_gt
                                                from 
                                                    ppm_tuyetnt.huycombohome cb1, 
                                                    ADMIN_HCM.nhanvien_mnv_hrm nvhrm,
                                                    Admin_hcm.nhanvien nv
                                                where 
                                                       manguoi_gt = nvhrm.manv_hcm
                                                    and nvhrm.mnv_hrms = nv.ma_nv
                                                    and to_char(to_date(cb.thoigian_dki,''dd/MM/yyyy hh24:mi:ss''),''YYYYMM'') = '''||v_thang||'''
                                                    and cb1.dayupdate = (select max(dayupdate) from ppm_tuyetnt.huycombohome where to_char(to_date(thoigian_dki,''dd/MM/yyyy hh24:mi:ss''),''YYYYMM'') = '''||v_thang||''')
                                              )
                  )
            ) group by ten_dv  order by ten_dv
        ) huy
        on (lm.ten_dv = huy.ten_dv)
      
    ';
     OPEN o_data FOR v_Query;
END combohome;

END DASHBOARD;